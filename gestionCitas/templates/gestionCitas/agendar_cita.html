{% extends "base.html" %}
{% block content %}

<style>
  .container {
    max-width: 700px;
    margin: 40px auto;
    padding: 20px;
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(15,23,42,0.05);
  }

  h2 {
    color: #16a34a;
    margin-bottom: 10px;
    text-align: center;
  }

  h3 {
    margin-top: 22px;
    margin-bottom: 10px;
    color: #111827;
  }

  .info-box {
    background-color: #f0fdf4;
    border-left: 4px solid #16a34a;
    padding: 12px;
    margin-bottom: 18px;
    border-radius: 4px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
  }

  input[type="time"],
  input[type="text"],
  input[type="email"],
  input[type="number"],
  select,
  textarea,
  input {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    box-sizing: border-box;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #16a34a;
    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.15);
  }

  .error-text {
    margin-top: 6px;
    color: #b91c1c;
    font-size: 0.9em;
  }

  .muted {
    color: #6b7280;
    font-size: 0.9rem;
    margin-top: 6px;
  }

  /* Alertas (status) */
  .alert {
    display: none;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 6px;
    font-weight: 600;
  }
  .alert-success { background: #dcfce7; border: 1px solid #86efac; color: #166534; display: block; }
  .alert-warning { background: #fef9c3; border: 1px solid #fde047; color: #854d0e; display: block; }
  .alert-danger  { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; display: block; }

  /* Caja para mascotas existentes */
  .box {
    display: none;
    margin-bottom: 16px;
    padding: 12px;
    background: #f9fafb;
    border: 1px dashed #d1d5db;
    border-radius: 6px;
  }

  .button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
  }

  .btn-primary {
    background-color: #16a34a;
    color: white;
  }

  .btn-primary:hover {
    background-color: #15803d;
  }

  .btn-secondary {
    background-color: #e5e7eb;
    color: #374151;
  }

  .btn-secondary:hover {
    background-color: #d1d5db;
  }

  .disabled {
    opacity: 0.65;
    pointer-events: none;
  }
</style>

<div class="container">
  <h2>Agendar cita</h2>

  <div class="info-box">
    <p style="margin:0;">
      <strong>Fecha:</strong> {{ bloque.fecha }}<br>
      <strong>Horario:</strong> {{ bloque.hora_inicio }} - {{ bloque.hora_fin }}<br>
      <strong>Veterinario:</strong> {{ bloque.veterinario.nombre }}
    </p>
  </div>

  <form method="post" id="agendar-form">
    {% csrf_token %}

    <h3>Datos del cliente</h3>
    <div id="cliente-status" class="alert"></div>

    {% if cliente_form.non_field_errors %}
      <div class="alert alert-danger" style="display:block;">
        {{ cliente_form.non_field_errors }}
      </div>
    {% endif %}

    {% for field in cliente_form %}
      <div class="form-group">
        {{ field.label_tag }}
        {{ field }}
        {% if field.errors %}
          <div class="error-text">{{ field.errors }}</div>
        {% endif %}
      </div>
    {% endfor %}

    <h3>Datos de la mascota</h3>
    <div id="mascota-status" class="alert"></div>

    <div id="mascotas-existentes" class="box">
      <label for="select-mascota-existente"><strong>Mascotas registradas del cliente</strong></label>
      <select id="select-mascota-existente">
        <option value="">-- Registrar nueva mascota --</option>
      </select>
      <div class="muted">Si selecciona una, se cargarán sus datos automáticamente.</div>
    </div>

    {% if mascota_form.non_field_errors %}
      <div class="alert alert-danger" style="display:block;">
        {{ mascota_form.non_field_errors }}
      </div>
    {% endif %}

    {% for field in mascota_form %}
      <div class="form-group">
        {{ field.label_tag }}
        {{ field }}
        {% if field.errors %}
          <div class="error-text">{{ field.errors }}</div>
        {% endif %}
      </div>
    {% endfor %}

    <h3>Motivo de la consulta</h3>
    <div class="form-group">
      <label for="motivo_consulta">Motivo</label>
      <input
        type="text"
        name="motivo_consulta"
        id="motivo_consulta"
        maxlength="30"
        value="{{ bloque.motivo_consulta|default_if_none:'' }}"
      >
    </div>

    <div class="button-group">
      <button type="submit" id="btn-submit" class="btn btn-primary">Confirmar cita</button>
      <a href="{% url 'gestionCitas:calendario_mes' %}" class="btn btn-secondary">Volver al calendario</a>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const clienteStatus = document.getElementById('cliente-status');
  const mascotaStatus = document.getElementById('mascota-status');
  const btnSubmit = document.getElementById('btn-submit');

  const mascotasContainer = document.getElementById('mascotas-existentes');
  const selectMascota = document.getElementById('select-mascota-existente');
  let mascotasData = [];

  // Inputs cliente (con prefix "cliente")
  const rutInput = document.getElementById('id_cliente-rut_cli');
  const nombreClienteInput = document.getElementById('id_cliente-nombre');
  const telefonoInput = document.getElementById('id_cliente-telefono');
  const emailInput = document.getElementById('id_cliente-email');
  const direccionInput = document.getElementById('id_cliente-direccion');

  // Inputs mascota (con prefix "mascota")
  const chipInput = document.getElementById('id_mascota-codigo_chip');
  const nombreMascotaInput = document.getElementById('id_mascota-nombre');
  const especieInput = document.getElementById('id_mascota-especie');
  const razaInput = document.getElementById('id_mascota-raza');
  const edadInput = document.getElementById('id_mascota-edad');
  const pesoInput = document.getElementById('id_mascota-peso');

  function setAlert(el, tipo, msg) {
    el.classList.remove('alert-success', 'alert-warning', 'alert-danger');
    el.classList.add('alert', tipo);
    el.textContent = msg;
    el.style.display = 'block';
  }

  function clearAlert(el) {
    el.classList.remove('alert-success', 'alert-warning', 'alert-danger');
    el.textContent = '';
    el.style.display = 'none';
  }

  function setSubmitEnabled(enabled) {
    if (enabled) {
      btnSubmit.classList.remove('disabled');
      btnSubmit.disabled = false;
      return;
    }
    btnSubmit.classList.add('disabled');
    btnSubmit.disabled = true;
  }

  function normalizarRut(valor) {
    return (valor || '')
      .replace(/\./g, '')
      .replace(/-/g, '')
      .replace(/\s+/g, '')
      .toUpperCase()
      .trim();
  }

  function rutEsCompleto(rut) {
    return /^(\d{7,8})([0-9K])$/.test(rut);
  }

  function debounce(fn, ms) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), ms);
    };
  }

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    return await res.json();
  }

  async function buscarClienteYAutocompletar(rutNormalizado) {
    if (!rutNormalizado) return;

    const urlCliente = `{% url 'gestionCitas:buscar_cliente' %}?rut=${encodeURIComponent(rutNormalizado)}`;
    const data = await fetchJSON(urlCliente);

    if (data.encontrado) {
      if (nombreClienteInput) nombreClienteInput.value = data.nombre || '';
      if (telefonoInput) telefonoInput.value = data.telefono || '';
      if (emailInput) emailInput.value = data.email || '';
      if (direccionInput) direccionInput.value = data.direccion || '';

      setAlert(clienteStatus, 'alert-success', '✓ Cliente encontrado (autocompletado).');
      await cargarMascotasDelCliente(rutNormalizado);
    } else {
      setAlert(clienteStatus, 'alert-warning', '⚠ Cliente nuevo. Complete los datos para crearlo.');
      mascotasContainer.style.display = 'none';
      selectMascota.innerHTML = '<option value="">-- Registrar nueva mascota --</option>';
      mascotasData = [];
    }
  }

  async function cargarMascotasDelCliente(rutNormalizado) {
    const urlMascotas = `{% url 'gestionCitas:buscar_mascotas_cliente' %}?rut=${encodeURIComponent(rutNormalizado)}`;
    const data = await fetchJSON(urlMascotas);

    mascotasData = Array.isArray(data.mascotas) ? data.mascotas : [];

    if (mascotasData.length > 0) {
      mascotasContainer.style.display = 'block';
      selectMascota.innerHTML = '<option value="">-- Registrar nueva mascota --</option>';

      mascotasData.forEach((m) => {
        const opt = document.createElement('option');
        opt.value = m.codigo_chip;
        opt.textContent = `${m.nombre} (${m.especie}) - Chip: ${m.codigo_chip}`;
        selectMascota.appendChild(opt);
      });
    } else {
      mascotasContainer.style.display = 'none';
      selectMascota.innerHTML = '<option value="">-- Registrar nueva mascota --</option>';
    }
  }

  function cargarMascotaEnFormulario(m) {
    if (chipInput) chipInput.value = m.codigo_chip || '';
    if (nombreMascotaInput) nombreMascotaInput.value = m.nombre || '';
    if (especieInput) especieInput.value = m.especie || '';
    if (razaInput) razaInput.value = m.raza || '';
    if (edadInput) edadInput.value = (m.edad ?? '') === null ? '' : (m.edad ?? '');
    if (pesoInput) pesoInput.value = m.peso || '';
  }

  function limpiarMascotaFormulario() {
    if (chipInput) chipInput.value = '';
    if (nombreMascotaInput) nombreMascotaInput.value = '';
    if (especieInput) especieInput.value = '';
    if (razaInput) razaInput.value = '';
    if (edadInput) edadInput.value = '';
    if (pesoInput) pesoInput.value = '';
  }

  async function buscarMascotaPorChip(chip) {
    const chipVal = (chip || '').trim();
    if (!chipVal) return;

    const urlMascota = `{% url 'gestionCitas:buscar_mascota' %}?chip=${encodeURIComponent(chipVal)}`;
    const data = await fetchJSON(urlMascota);

    if (data.encontrado) {
      cargarMascotaEnFormulario({
        codigo_chip: chipVal,
        nombre: data.nombre,
        especie: data.especie,
        raza: data.raza,
        edad: data.edad,
        peso: data.peso
      });

      setAlert(mascotaStatus, 'alert-success', '✓ Mascota encontrada (autocompletada).');

      const rutDueno = normalizarRut(data.rut_dueno || '');
      const rutActual = normalizarRut(rutInput ? rutInput.value : '');

      if (rutDueno) {
        if (!rutActual) {
          rutInput.value = rutDueno;
          await buscarClienteYAutocompletar(rutDueno);
        } else if (rutActual !== rutDueno) {
          setAlert(mascotaStatus, 'alert-danger', '✗ Este chip pertenece a otro cliente. Corrija el RUT o use otra mascota.');
          setSubmitEnabled(false);
          return;
        }
      }
      setSubmitEnabled(true);
    } else {
      setAlert(mascotaStatus, 'alert-warning', '⚠ Mascota nueva. Complete los datos para registrarla.');
      setSubmitEnabled(true);
    }
  }

  const onRutChange = debounce(async function () {
    if (!rutInput) return;

    const rutNorm = normalizarRut(rutInput.value);
    rutInput.value = rutNorm;

    if (!rutNorm) {
      clearAlert(clienteStatus);
      mascotasContainer.style.display = 'none';
      selectMascota.innerHTML = '<option value="">-- Registrar nueva mascota --</option>';
      mascotasData = [];
      return;
    }

    if (rutEsCompleto(rutNorm)) {
      setSubmitEnabled(true);
      await buscarClienteYAutocompletar(rutNorm);
    } else {
      clearAlert(clienteStatus);
      mascotasContainer.style.display = 'none';
      selectMascota.innerHTML = '<option value="">-- Registrar nueva mascota --</option>';
      mascotasData = [];
    }
  }, 250);

  const onChipChange = debounce(async function () {
    if (!chipInput) return;

    const chipVal = (chipInput.value || '').trim();
    if (!chipVal) {
      clearAlert(mascotaStatus);
      setSubmitEnabled(true);
      return;
    }

    if (chipVal.length >= 5) {
      setSubmitEnabled(true);
      await buscarMascotaPorChip(chipVal);
    } else {
      clearAlert(mascotaStatus);
      setSubmitEnabled(true);
    }
  }, 250);

  if (rutInput) rutInput.addEventListener('input', onRutChange);
  if (chipInput) chipInput.addEventListener('input', onChipChange);

  if (selectMascota) {
    selectMascota.addEventListener('change', function () {
      const chipElegido = this.value;

      if (!chipElegido) {
        limpiarMascotaFormulario();
        clearAlert(mascotaStatus);
        setSubmitEnabled(true);
        return;
      }

      const m = mascotasData.find(x => x.codigo_chip === chipElegido);
      if (m) {
        cargarMascotaEnFormulario(m);
        setAlert(mascotaStatus, 'alert-success', '✓ Mascota cargada desde registros del cliente.');
        setSubmitEnabled(true);
      }
    });
  }
});
</script>

{% endblock %}
