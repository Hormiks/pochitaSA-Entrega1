{% extends "base.html" %}

{% block content %}

<style>
  body {
    background-color: #f8fafc;;
  }
  .agenda-page {
      width: 100%;
      margin: 0 auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f8fafc;
      min-height: 100vh;
  }

  .page-header {
    
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #ffffff;
      padding: 18px 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 0;
  }
  .page-header-left h2 {
      margin: 0;
      font-size: 1.4rem;
  }
  .page-header-left p {
      margin: 4px 0 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
  }

  .page-header-right {
      display: flex;
      gap: 10px;
  }
  .icon-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background-color: rgba(255,255,255,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
  }

  .toolbar {
      margin: 0 auto;
      background-color: #ffffff;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 0 16px;
      min-height: 10vh;
      
  }

  .toolbar-left,
  .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
  }

  .toolbar label {
      font-size: 0.85rem;
      margin-right: 4px;
  }

  .toolbar input[type="date"],
  .toolbar select {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
  }

  .btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
  }
  .btn-primary {
      background-color: #f97316;
      color: white;
  }
  .btn-outline {
      background-color: white;
      border: 1px solid #d1d5db;
      color: #374151;
  }

  .content-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
  }

  .grid-agenda {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 40px;
  }

  .section {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.05);
      padding: 20px;
      height: fit-content;
  }

  .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
  }
  .section-title h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
  }
  .section-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 4px;
  }

  .legend {
      display: flex;
      gap: 12px;
      font-size: 0.8rem;
      align-items: center;
      flex-wrap: wrap;
  }
  .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 4px;
  }
  .dot-completada { background-color: #22c55e; }
  .dot-encurso    { background-color: #eab308; }
  .dot-programada { background-color: #3b82f6; }

  .citas-lista {
      display: flex;
      flex-direction: column;
      gap: 16px;
  }

  .cita-item {
      border-radius: 10px;
      padding: 16px;
      background: #f9fafb;
      border-left: 4px solid #3b82f6;
      position: relative;
  }

  .cita-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
  }

  .cita-id {
      font-weight: 600;
      font-size: 0.9rem;
  }

  .cita-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
  }

  .action-link {
      font-size: 0.75rem;
      color: #3b82f6;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 2px;
      justify-content: center;
      text-align: center;
  }

  .action-link:hover {
      text-decoration: underline;
  }

  .cita-details {
      font-size: 0.85rem;
      color: #4b5563;
  }

  .cita-details div {
      margin-bottom: 4px;
  }

  .cita-motivo {
      margin-top: 8px;
      font-weight: 500;
  }

  .horarios-lista {
      display: flex;
      flex-direction: column;
      gap: 16px;
  }

  .horario-item {
      border-radius: 10px;
      padding: 16px;
      background: #f0fdf4;
      border-left: 4px solid #22c55e;
      position: relative;
  }

  .horario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
  }

  .horario-hora {
      font-weight: 600;
      font-size: 0.95rem;
  }

  .horario-vet {
      font-size: 0.85rem;
      color: #6b7280;
  }

  .btn-agendar {
      background-color: #f97316;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 500;
  }

  .btn-agendar:hover {
      background-color: #ea580c;
  }

  .footer {
      background-color:white;
      color: black;
      padding: 20px;
      
      margin-top: 40px;
      border-radius: 0;
  }

  .footer-content {
      max-width: 1200px;
      margin: 0 auto;
  }

  .footer h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
  }

  .footer p {
      margin: 4px 0;
      font-size: 0.85rem;
      opacity: 0.8;
  }

  .rol-actual {
      margin-top: 12px;
      font-size: 0.8rem;
      opacity: 0.7;
  }

  .muted {
      color: #9ca3af;
      font-size: 0.9rem;
      text-align: center;
      padding: 20px;
  }

  @media (max-width: 900px) {
      .grid-agenda {
          grid-template-columns: 1fr;
      }
      
      .toolbar {
          flex-direction: column;
          align-items: flex-start;
      }
      
      .toolbar-right {
          margin-top: 12px;
      }
      
      .cita-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
      }
      
      .cita-actions {
          align-self: flex-end;
      }
  }
  td {
      padding: 8px;
      text-align: left;
      vertical-align: top;
      background-color: #ffffff;
  }
  th {
      background-color: #22c55e;
      color: white;
      padding: 10px;
  }
  .estado {
      font-weight: bold;
      display: flex; 
      justify-content: center; 
      width: 100%;
      
  }


</style>

<div class="agenda-page">
  <!-- HEADER VERDE -->
  <div class="page-header">
    <div class="page-header-left">
      <h2>GestiÃ³n de Citas</h2>
      <p>GestiÃ³n de citas, calendario veterinario</p>
    </div>
    <div class="page-header-right">
      <div class="icon-badge">ðŸ””</div>
    </div>
  </div>

  <!-- BARRA SUPERIOR: FILTRO FECHA / VETERINARIO -->
  <div class="toolbar">

    <form method="get" action="" style="display:flex; align-items:center; justify-content:space-between; gap:16px; width:100%;">
      <!-- Filtro por mes -->
      <label for="mes">Seleccionar mes:</label>
      <select name="month" id="month" onchange="this.form.submit()">
        {% for mes_num, mes_nombre in meses %}
          <option value="{{ mes_num }}" {% if mes_num == month %}selected{% endif %}>
            {{ mes_nombre }}
          </option>
        {% endfor %}
      </select>

      <!-- Filtro por aÃ±o -->
      <label for="year">Seleccionar aÃ±o:</label>
      <select name="year" id="year" onchange="this.form.submit()">
        {% for anio in anios %}
          <option value="{{ anio }}" {% if anio == year %}selected{% endif %}>
            {{ anio }}
          </option>
        {% endfor %}
      </select>


      <div class="toolbar-right" style="display:flex; align-items:center; gap:16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label for="veterinario">Filtrar por veterinario:</label>
          <select id="veterinario" name="veterinario">
            <option value="">Todos los veterinarios</option>
            {% for vet in veterinarios %}
              <option value="{{ vet.rut_vet }}" {% if vet.rut_vet == veterinario_seleccionado %}selected{% endif %}>{{ vet.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div style="align-self:flex-end;">
          <button class="btn btn-primary" type="submit">
            Actualizar
          </button>
        </div>
      </div>
    </form>
</div>

  <div class="content-container">
    <!-- TÃTULO & LEYENDA -->
     <h3 style="text-align: center;">Calendario de citas</h3>
    <div class="section-title" style="margin-bottom: 20px; padding: 0 8px;">
        
        <div class="section-subtitle">
          {{ month_name }} {{ year }}
          {% if veterinario_seleccionado and veterinario_nombre %}
            &nbsp;â€“&nbsp; {{ veterinario_nombre }}
          {% endif %}
        </div>
      
    </div>

    <!-- Estilo para la selecciÃ³n de veterinarios -->
    <style>
      .vet-selection {
        margin-bottom: 20px;
      }

      .vet-container {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .vet-card {
        background-color: #f3f4f6;
        padding: 12px 24px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
      }

      .vet-card.selected {
        background-color: #22c55e;
        color: white;
      }

      .vet-card:hover {
        background-color: #e4e4e7;
      }

      .vet-icon {
        font-size: 1.2rem;
      }

      .vet-card p {
        margin: 0;
        font-weight: bold;
      }
    </style>

    <!-- Calendario -->
    <table border="1">
      <thead>
        <tr>
          <th>Lunes</th>
          <th>Martes</th>
          <th>MiÃ©rcoles</th>
          <th>Jueves</th>
          <th>Viernes</th>
          <th>SÃ¡bado</th>
          <th>Domingo</th>
        </tr>
      </thead>
      <tbody>
        {% for semana in semanas %}
          <tr>
            {% for dia in semana %}
              <td valign="top" style="min-width: 140px;">
                {% if dia %}
                  <strong>{{ dia.fecha.day }}</strong><br>
                  {% for bloque in dia.bloques %}
                    <div style="margin-top:4px; padding:3px; border:1px solid #ccc;">
                      <small style="justify-content: center; width: 100%; display: flex;">{{ bloque.hora_inicio }} - {{ bloque.hora_fin }}</small>
                      <hr>
                      <small><strong>Vet:</strong> {{ bloque.veterinario.nombre }}</small><br>

                      {% if bloque.estado == 'DISPONIBLE' %}
                        <span class="estado" style="color:green; ">Disponible</span>
                        <hr>
                        <a style="background-color: #16a34a93; color: #ffffff; display:inline-block; padding: 8px 16px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 0.75rem; width: 100%; box-sizing: border-box;" href="{% url 'gestionCitas:agendar_cita' bloque.pk %}">Agendar</a>
                      {% elif bloque.estado == 'RESERVADO' %}
                        <small><strong>Mascota:</strong> {{ bloque.mascota }}</small>
                        <span class="estado" style="color:orange;">Reservado</span>
                        <hr>
                        <form method="get" action="{% url 'gestionCitas:reprogramar_cita' bloque.pk %}" style="display:inline; margin:0; width:100%;">
                          <button type="submit" style="background-color: #302de1aa; color: #ffffff; border: none; border-radius: 6px; padding: 8px 16px; font-size: 0.75rem; cursor: pointer; text-align: center; width: 100%; margin-bottom: 4px;">Reprogramar</button>
                        </form>
                        <form method="post" action="{% url 'gestionCitas:cancelar_bloques_veterinario' bloque.pk %}" style="display:inline; margin:0; width:100%;">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{% url 'gestionCitas:calendario_mes' %}?year={{ year }}&month={{ month }}{% if veterinario_seleccionado %}&veterinario={{ veterinario_seleccionado }}{% endif %}">
                          <button type="submit" style="background-color: #ea3b3b89; color: #ffffff; border: none; border-radius: 6px; padding: 8px 16px; font-size: 0.75rem; cursor: pointer; text-align: center; width: 100%;" onclick="return confirm('Â¿EstÃ¡s seguro de que quieres cancelar esta cita?');">Cancelar</button>
                        </form>
                      {% elif bloque.estado == 'CANCELADO_VET' %}
                        <span class="estado" style="color:red;">Cancelado</span>
                        <hr>
                        <a style="background-color: #16a34a9f; color: #ffffff; display:inline-block; padding: 8px 16px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 0.75rem; width: 100%; box-sizing: border-box;" href="{% url 'gestionCitas:agendar_cita' bloque.pk %}">Agendar</a>
                      {% elif bloque.estado == 'COMPLETADA' %}
                        <small><strong>Mascota:</strong> {{ bloque.mascota }}</small>
                        <span class="estado" style="color:#22c55e;">âœ“ Completada</span>
                      {% endif %}
                    </div>
                  {% empty %}
                    <small>Sin bloques</small>
                  {% endfor %}
                  <!-- BotÃ³n siempre visible para aÃ±adir mÃ¡s bloques -->
                  <a style="background-color: #3b82f6; color: #ffffff; display:inline-block; padding: 8px 16px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 0.75rem; width: 100%; box-sizing: border-box; margin-top: 8px;" href="{% url 'gestionCitas:agregar_disponibilidad' dia.fecha|date:'Y-m-d' '0' %}">+ AÃ±adir bloque</a>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
</div>
<div class="footer">
    <div class="footer-content">
      <h3>Veterinaria Pochita</h3>
      <p>Sistema de GestiÃ³n Veterinaria v1.0</p>
      <p>Â© 2025 Veterinaria Pochita. Todos los derechos reservados.</p>
    </div>
  </div>
{% endblock %}
